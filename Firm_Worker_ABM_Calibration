import pandas as pd
import numpy as np
import Data201_FINAL_ABM as abm

#Scale salary, load data and get target values
unit_conversion = 1000
data = pd.read_csv('Employers_data.csv')
target_median_salary = data['Salary'].median() / unit_conversion

#Parameter to Calibrate
salary_scale = np.array([1.0])
errors_salary = [1]
counter = 0

#Calibration Loop
while ( np.mean(1 - abs(np.asarray(errors_salary))) < 0.99) and counter < 20:
    
    salary_mult = salary_scale[0]
    
    #Run ABM with Parameters
    NUM_FIRMS = 20
    NUM_WORKERS = 1000
    STEPS = 200   #Shorter run for calibration purposes
    
    firms = [abm.Firm(i, np.round(np.random.uniform(70,130), 2)) for i in range(NUM_FIRMS)]
    workers = [abm.Worker(i, abm.random_education(), np.round(np.random.uniform(0,30))) for i in range(NUM_WORKERS)]
    unemployment_history = []
    profit_history = {firm.id: [] for firm in firms}
    
    #Apply wage scaling
    for w in workers:
        w.reservation_wage *= salary_mult
    
    #Run Simulation
    for _ in range(STEPS):
        num_unemployed = sum(1 for w in workers if w.employed == 0)
        initial_worker_count = len(workers)

        abm.hiring_phase(firms, workers, num_unemployed)
        abm.profits_layoffs_phase(firms, profit_history)
        abm.update_workers_phase(workers)
        abm.job_switching_phase(workers, firms)
        abm.retirement_replacement_phase(workers, initial_worker_count)
        abm.calculate_unemployment(workers, unemployment_history)
    
    #Compute the simulated statistics    
    employed_wages = [w.reservation_wage for w in workers if w.employed == 1]
    sim_salary = np.median(employed_wages) if employed_wages else 0.0
    
    #Update the salary scale
    errors_salary = []
    rel_error_salary = (target_median_salary - sim_salary) / target_median_salary
    new_salary_mult = salary_mult * (1 + rel_error_salary)
    if new_salary_mult <= 0:
        new_salary_mult = 0.01
    if new_salary_mult > 10:
        new_wage_mult = 10.0
    salary_scale[0] = new_salary_mult
    if new_salary_mult <= 0:
        new_salary_mult = 0.01
    salary_scale[0] = new_salary_mult
    errors_salary.append(rel_error_salary)
    
    #Print the errors
    print(f'Counter {counter}: '
          f'salary_scale={salary_scale[0]}, sim_salary={sim_salary}, '
          f'target_median_salary={target_median_salary}')
    
    counter += 1
 
#Save calibrated parameters
df_final = pd.DataFrame()
df_final['Salary Scale'] = salary_scale
df_final['Salary Error'] = errors_salary
df_final.to_csv('Calibrated_Employers.csv', index=False)

